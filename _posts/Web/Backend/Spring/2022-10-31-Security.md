---
permalink: /Backend/Spring/LoginBySecurity/
title: "Spring Securityë¥¼ ì´ìš©í•œ ë¡œê·¸ì¸ ì²˜ë¦¬ "
toc: true
categories:
  - BackendğŸ¦„Spring
comments: true
sidebar:
  - title: "BackendğŸ¦„"
  - nav: "Backend-menu"
tags:
  - Spring
  - Java
  - Spring Security
sexy: 1
main: "Spring"
header:
  teaser: https://images.velog.io/images/park9910/post/dc139b53-7a2c-4973-ba88-23fb96b06b2e/image.png
  overlay_image: https://images.velog.io/images/park9910/post/dc139b53-7a2c-4973-ba88-23fb96b06b2e/image.png
  overlay_filter: 0.5
excerpt: \#Spring Security \#SpringSecurity \#Login
---

<span style = "font-size:1.5em;  font-weight: 700;">SpringSecurityë¥¼ ì´ìš©í•˜ì—¬ ë¡œê·¸ì¸ ì²˜ë¦¬ë¥¼ í•´ë³´ì</span><br>
**Spring Security**ë¥¼ ì´ìš©í•˜ì—¬ ì œëŒ€ë¡œ ëœ ë¡œê·¸ì¸ ì²˜ë¦¬ë¥¼ í•´ë³´ì
{: .notice--info}


# 0. ì •ì±…
- íšŒì›ê°€ì…ì´í›„ íšŒì›ê°€ì…ì´ ì •ìƒì ìœ¼ë¡œ ì™„ë£Œëœ ê²ƒì´ ì•„ë‹ˆë¼ ì´í›„ì— **ì´ë©”ì¼ ì¸ì¦**ì´ ì¶”ê°€ì ìœ¼ë¡œ í•„ìš”í•˜ë‹¤
- **ì´ë©”ì¼ ì¸ì¦**ì´ ì™„ë£Œë˜ì–´ì•¼ë§Œ ì •ìƒì ìœ¼ë¡œ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•  ìˆ˜ ìˆë‹¤
- ë¹„ë°€ë²ˆí˜¸ê°€ 5íšŒì´ìƒ í‹€ë¦´ì‹œ ê³„ì •ì´ ì ê¸´ë‹¤

# 1. WebSecurity

{% highlight java linenos %}
@Configuration
@EnableWebSecurity
@RequiredArgsConstructor
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {

    private final CustomAuthenticationProvider authProvider;

    private final AuthSuccessHandler authSuccessHandler;
    private final AuthFailureHandler authFailureHandler;

    private final WebAccessDeniedHandler webAccessDeniedHandler;


    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
                .csrf().disable()
                .authorizeRequests()
                .antMatchers("/login","/js/*", "/css/*", "/img/*", "/test/failAuth", "/test/failSso","/verify/*").permitAll() // ê²ŒìŠ¤íŠ¸(ë¹„íšŒì›)ì´ ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ” í˜ì´ì§€
                .antMatchers("/email").hasAnyRole("NOT_PERMITTED","USER") // NOT_PERMITTED = íšŒì›ê°€ì…ì€ í–ˆì§€ë§Œ ì´ë©”ì¼ì¸ì¦ì„ ì•ˆí•œ íšŒì›, USER = íšŒì›ê°€ì… + ì´ë©”ì¼ì¸ì¦ ì ˆì°¨ê°€ ì™„ë£Œëœ íšŒì›
                .anyRequest().hasRole("USER") //ë‚˜ë¨¸ì§€ í˜ì´ì§€ëŠ” íšŒì›ë§Œ ì‚¬ìš©ê°€ëŠ¥
                .and()
                .formLogin() //Securityì—ì„œ ì œê³µí•´ì£¼ëŠ” LoginProcessë¥¼ ì‚¬ìš©í•œë‹¤
                .loginPage("/login")
                .successHandler(authSuccessHandler)
                .failureHandler(authFailureHandler)
                .usernameParameter("loginId")
                .passwordParameter("loginPassword")
                .and()
                .logout()
                .invalidateHttpSession(true)
                .deleteCookies("JSESSIONID")
                .permitAll()
                .and()
                .exceptionHandling()
                .accessDeniedHandler(webAccessDeniedHandler);
    }

    /**
     * ì¸ì¦/ì¸ê°€ í™•ì¸ í”„ë¡œì„¸ì„œ ì£¼ì…
     * @param auth the {@link AuthenticationManagerBuilder} to use
     * @throws Exception
     * @see CustomAuthenticationProvider
     */
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        auth.authenticationProvider(authProvider);
    }

}
{% endhighlight %}
- `formLogin()`: ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ê°€ ì œê³µí•˜ëŠ” ë¡œê·¸ì¸ ì¸ì¦ ë°©ì‹ì„ ì‚¬ìš©í•œë‹¤
-  `loginPage("/login")`: resource í´ë”ì— ìˆëŠ” login.htmlì„ ì‚¬ìš©í•œë‹¤
- ë¡œê·¸ì¸ì‹œ `JSESSIONID`ì¿ í‚¤ì— ì €ì¥ë˜ê¸°ë•Œë¬¸ì— ì¿ í‚¤ë„ ì‚­ì œí•´ì¤€ë‹¤  
    **login.html**


    ```html
    <body>
      <div class="form" id="form">
          <div id="unableLogin" role="alert">
              ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.
          </div>
          <div class="field email">
              <div class="icon"></div>
              <input class="input" id="loginId" name="loginId" type="text" placeholder="id" autocomplete="off"/>
          </div>
          <div class="field password">
              <div class="icon"></div>
              <input class="input" id="loginPassword" name="loginPassword" type="password" placeholder="Password"/>
          </div>
          <button class="button" id="submit">LOGIN</button>
          <small>Fill in the form</small>
      </div>
    </body>
    ```
    - formíƒœê·¸ë¥¼ ì‚¬ìš©í•˜ì§€ì•Šê³  buttonì„ ì´ìš©í•˜ì—¬ jsë¡œ ë°±ì—”ë“œ ì„œë²„ì—ê²Œ ì „ë‹¬í•œë‹¤
    - ì—¬ê¸°ì„œ ì‚¬ìš©ë˜ëŠ” `id="loginId" name="loginId"`ì™€ `id="loginPassword" name="loginPassword"`ì´ ë¶€ë¶„ê³¼ WebSecurityConfig.configureì—ì„œì˜  
    ```java
    http
    ...
    .usernameParameter("loginId")
    .passwordParameter("loginPassword")
    ...
    ```
    ì´ë ‡ê²Œ ë§¤ì¹˜ë¥¼ ì‹œì¼œì£¼ì–´ì•¼í•œë‹¤
    
    **login.js**


    ```js
    $submit.click(function() {
        $('#unableLogin').hide();

        $.ajax({
            url: '/login',
            type: 'post',
            dataType: 'json',
            //contentType: 'application/json',
            data: {
                loginId: $('#loginId').val(),
                loginPassword: $('#loginPassword').val()
            },
            success : function(result){
                $("#unableLogin").text(result);
            }, error : function(request, errorcode, error){
                const errorMessage = request.responseText;
                document.getElementById("unableLogin").innerHTML=errorMessage;
                //$('#unableLogin').text(errorMessage);
            },
            statusCode: {
                200: function () {
                    $('#unableLogin').hide();
                    //ë¹„íšŒì›ì´ ê¸°ì¡´ ì‚¬ìš©í•˜ë ¤ëŠ” ì„œë¹„ìŠ¤ í˜ì´ì§€ë¡œ redirectí•´ì•¼í•¨
                },
                401: function () {
                    $('#unableLogin').show(2000);
                },
                405: function () {
                    $('#unableLogin').show(2000);
                },
                404: function () {
                    $('#unableLogin').show(2000);
                },
                400: function () {
                    $('#unableLogin').show(2000);
                },
                409: function () {
                    $('#unableLogin').show(2000);
                }
            }

        });
    });
    ```
    - formë°©ì‹ìœ¼ë¡œ ì „ì†¡í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆê¸°ë•Œë¬¸ì— ajaxë¥¼ í†µí•˜ì—¬ postë°©ì‹ìœ¼ë¡œ /loginìœ¼ë¡œ ë³´ë‚¸ë‹¤
    - ì´ ë•Œì˜ `/login`ì˜ RequestMappingì€ SpringSecurityê°€ ë§Œë“¤ì–´ë†“ì€ ê²ƒì„ ì‚¬ìš©í•œë‹¤

- `invalidateHttpSession`
  - ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ê°€ ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ë°©ì‹ì„ **HttpSession**ì„ ê¸°ë³¸ìœ¼ë¡œ í•œë‹¤
  - ë¸Œë¼ìš°ì €ë¥¼ ì¢…ë£Œí•˜ì§€ ì•Šì„ ë•Œ, ë¡œê·¸ì•„ì›ƒì„ í–‰í•´ì„œ ìì‹ ì´ ë¡œê·¸ì¸ í–ˆë˜ ëª¨ë“  ì •ë³´ë¥¼ ì‚­ì œí•œë‹¤
- `exceptionHandling` : ì¸ê°€ì˜ˆì™¸ ì‘ë™
- `accessDeniedHandler(webAccessDeniedHandler)`: ì‚¬ìš©ìê°€ ê¶Œí•œì—†ëŠ” í˜ì´ì§€ì— ë“¤ì–´ê°”ì„ë•Œ Handling, ì¦‰. ì¸ê°€ì‹¤íŒ¨ì‹œ ì²˜ë¦¬

## cf. ROLE
ì‚¬ìš©ìì˜ ê¶Œí•œ ì¢…ë¥˜
{% highlight java linenos %}
public enum Role {
    ROLE_NOT_PERMITTED, ROLE_USER, ROLE_MANAGER, ROLE_ADMIN
}
{% endhighlight %}
- `ROLE_NOT_PERMITTED`: ì´ë©”ì¼ ì¸ì¦ì•ˆëœ ìœ ì €
- `ROLE_USER`: ì´ë©”ì¼ ì¸ì¦ì´ ì™„ë£Œëœ ìœ ì €
- `ROLE_ADMIN`: ìš´ì˜ì


# ë™ì‘ìˆœì„œ
1. ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” `formlogin()`ì„ ì‚¬ìš©í•˜ë©´ ì¸ì¦ í•„í„°ì¸ `UsernamePasswordAuthenticationFilter`ë¥¼ ì‚¬ìš©í•œë‹¤
   - ë§Œì•½ í† í° ê¸°ë°˜ì´ë‚˜ ë‹¤ë¥¸ ë°©ì‹ìœ¼ë¡œ ì§ì ‘ í•„í„°ë¥¼ ë§Œë“¤ê±°ë©´ `UsernamePasswordAuthenticationFilter`ë¥¼ ìƒì†ë°›ì•„ ì§ì ‘ í•„í„°ë¥¼ ë§Œë“ ë‹¤
2. ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ í˜ì´ì§€ë¥¼ í†µí•˜ì—¬ ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•œë‹¤.(`AntPathRequestMatcher`ê°€ ìš”ì²­ ì •ë³´ì˜ urlì´ í•´ë‹¹ê°’ì¸ì§€ í™•ì¸í•˜ê³  ë¡œì§ì„ ì‹œì‘í•œë‹¤)
   - urlì€ `.loginProcessingUrl(â€œ/login")`ë¡œ ì„¤ì •í•œë‹¤. ê¸°ë³¸ê°’: `/login`
3. ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ Usernameê³¼ passwordì •ë³´ê°€ ë‹´ê¸´ `Authentication`ê°ì²´ë¥¼ ìƒì„±í•˜ì—¬ `AuthenticationManager`ì— ë„˜ê¸´ë‹¤
4. `AuthenticationManager`ëŠ” ì´ì „ì— ë°›ì€ `Authenticaton`ê°ì²´ë¥¼ `AuthenticationProvider` ì— ë„˜ê²¨ì¤€ë‹¤
5. `AuthenticationProvider`ëŠ” ì‹¤ì œë¡œ ë¡œê·¸ì¸ì²˜ë¦¬ë¥¼ í•˜ë„ë¡ í•´ì¤€ë‹¤
  - `Authenticaton`ì—ì„œ ì‚¬ìš©ìê°€ ì…ë ¥í•œID í•„ë“œê°’ì„ í†µí•´ DBì— ìˆëŠ” ì‚¬ìš©ì ì •ë³´(=`UserDetails`)ë¥¼ ê°€ì ¸ì™€ ê²€ì¦í•œë‹¤
  - ë¡œê·¸ì¸ ì¸ì¦ì´ ì„±ê³µí•  ê²½ìš° `ìµœì¢… Authentication`ì™€ í•¨ê»˜ `AuthenticationSuccessHandler`ë¥¼ í†µí•´ ì„±ê³µ í•¸ë“¤ëŸ¬ ì²˜ë¦¬ê°€ ëœë‹¤
  - ë¡œê·¸ì¸ ì¸ì¦ì´ ì‹¤íŒ¨í•  ê²½ìš° `AuthenticationFailureHandler`ë¥¼ í†µí•´ ì‹¤íŒ¨ í•¸ë“¤ëŸ¬ ì²˜ë¦¬ê°€ ëœë‹¤
5. ì°¸ê³ ë¡œ `ìµœì¢… Authentication`ì€ *Spring Context*ì— ì €ì¥ëœë‹¤

<span style = "font-size:1.5em;  font-weight: 700;">ê°ê° êµ¬í˜„ì²´</span><br>
`AuthSuccessHandler` -> `AuthenticationSuccessHandler`<br>
`AuthFailureHandler` -> `AuthenticationFailureHandler`<br>
`AuthenticationProvider` -> `CustomAuthenticationProvider`<br>
`AccessDeniedHandler` -> `WebAccessDeniedHandler`<br>
`UserDetails` -> `Member`
{: .notice--info}

# 2. AuthenticationProvider
{% highlight java linenos %}
@Component
@RequiredArgsConstructor
public class CustomAuthenticationProvider implements AuthenticationProvider {


    private final UserDetailsService customUserDetailsService;

    private final PasswordEncoder passwordEncoder;

    private final LoginMapper loginMapper;


    @Override
    public Authentication authenticate(Authentication authentication) throws AuthenticationException {
        if(authentication == null){
            throw new InternalAuthenticationServiceException("ì¸ì¦ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤");
        }
        String username = authentication.getName();
        if(authentication.getCredentials() == null){
            throw new AuthenticationCredentialsNotFoundException("Credentialsì´ ì—†ìŠµë‹ˆë‹¤");
        }
        String password = authentication.getCredentials().toString();
        try {
            /* ì‚¬ìš©ì ì •ë³´ ë°›ê¸° */
            Member loadedUser = (Member) customUserDetailsService.loadUserByUsername(username);
            if (loadedUser == null) {
                throw new InternalAuthenticationServiceException("ìœ ì €ì •ë³´ê°€ ì…ë ¥ë˜ì§€ì•Šì•˜ìŠµë‹ˆë‹¤");
            }
            if (!loadedUser.isAccountNonLocked()) {
                throw new LockedException("ì ê¸´ ê³„ì •ì…ë‹ˆë‹¤");
            }
            if (!loadedUser.isEnabled()) {
                throw new DisabledException("íƒˆí‡´í•œ ê³„ì •ì…ë‹ˆë‹¤");
            }
            if (!loadedUser.isAccountNonExpired()) {
                throw new AccountExpiredException("ê¸°í•œ ë§Œë£Œ ê³„ì •ì…ë‹ˆë‹¤");
            }
            /** ì‹¤ì§ˆì ì¸ ì¸ì¦ ì‹œì‘ **/
            if (!passwordEncoder.matches(password, loadedUser.getPassword())) {

                // ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ í‹€ë¦° íšŸìˆ˜ ì¦ê°€
                loginMapper.increaseFailCnt(loadedUser.getMbrId());

                // ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ í‹€ë¦° íšŸìˆ˜ 5íšŒì¼ì‹œ
                if("0".equals(loadedUser.getRemainFailCnt()))
                    throw new BadCredentialsException("5íšŒì´ìƒ ì•„ì´ë””ë‚˜ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤. <br> ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”");

                // í‹€ë¦°íšŸìˆ˜ê°€ 5íšŒê°€ ì•„ë‹ì‹œ
                throw new BadCredentialsException("ì•„ì´ë””ë‚˜ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. <br> ë‚¨ì€ íšŸìˆ˜ëŠ” " + loadedUser.getRemainFailCnt() + "íšŒì…ë‹ˆë‹¤");
            }
            if (!loadedUser.isCredentialsNonExpired()) {
                throw new CredentialsExpiredException("ì¸ì¦ê¸°í•œì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤");
            }
            /** ì¸ì¦ ì„±ê³µ **/
            UsernamePasswordAuthenticationToken result = new UsernamePasswordAuthenticationToken(loadedUser, null, loadedUser.getAuthorities());
            result.setDetails(authentication.getDetails());
            return result;
        }
        catch (NoMemberException e){
            throw new NoMemberException("í•´ë‹¹ ì•„ì´ë””ëŠ” ì—†ìŠµë‹ˆë‹¤");
        }
    }

    @Override
    public boolean supports(Class<?> authentication) {
        return UsernamePasswordAuthenticationToken.class.isAssignableFrom(authentication);
    }
}
{% endhighlight %}
> 25ë²ˆ ë¼ì¸ì„ ë³´ë©´ `UserDetailsService`ì˜ `loadUserByUsername`ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.  
> ì´í›„ ë¼ì¸ì„ ë³´ë©´ `loadUserByUsername`ì„` í†µí•´ ë°›ì•„ì˜¨ `UserDetailsService`ì˜ êµ¬í˜„ì²´ `Member`ë¥¼ ê²€ì¦í•˜ì—¬ ê²€ì¦ì‹¤íŒ¨ì¼ê²½ìš° **Exception**ì„ ë˜ì§€ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

# 3. UserDetailsService
{% highlight java linenos %}
@Service
@RequiredArgsConstructor
public class LoginService implements UserDetailsService {

    private final LoginRepository loginRepository;
    private final ApiService apiService;
    private final Integer MAX_FAIL = 5;


    public Optional<LoginUser> findById(String loginId){
        return loginRepository.findById(loginId);
    }
    public Optional<UserInfo> findUserInfoByMbrId(String mbrId){
        return loginRepository.findUserInfoByMbrId(mbrId);
    }

    public LoginUserDto findUserByLoginId(String loginId){
        LoginUser loginUser = loginRepository.findUserByLoginId(loginId).orElseThrow(NoMemberException::new);
        return LoginUserDto.from(loginUser);
    }
    /**
     * <h3>ì‚¬ìš©ìê°€ ì…ë ¥í•œ IDê°’ì— ë”°ë¼ DBì—ì„œ ì‚¬ìš©ì ì •ë³´(={@link Member}) ì¶œë ¥</h3>
     * @param loginId the username identifying the user whose data is required.
     * @see CustomAuthenticationProvider#authenticate(Authentication)
     * @throws UsernameNotFoundException
     * @author ê¹€ì°¬ì˜
     */
    @Override
    public UserDetails loadUserByUsername(String loginId) throws UsernameNotFoundException {

        //íŒŒë¼ë¯¸í„° ê²€ì¦
        CustomAssert.isLoginPattern(loginId, "ì•„ì´ë””ë‚˜ ë¹„ë°€ë²ˆí˜¸ íŒ¨í„´ì´ ë§ì§€ì•ŠìŠµë‹ˆë‹¤");

        LoginUserDto loginUserDto = this.findUserByLoginId(loginId);


        if (loginUserDto.getFailCnt() >= MAX_FAIL)
            throw new LockedException("ê³„ì • ì •ì§€");

        Member member =
                (isNoAuthorizedMember(loginUserDto)) ? creatNoEmailMember(loginUserDto) : creatAuthorizedMember(loginUserDto);

        return member;
    }

    private Boolean isNoAuthorizedMember(LoginUserDto loginUserDto){
        return (!"Y".equals(loginUserDto.getMbrEmailYn()) || StringUtils.isEmpty(loginUserDto.getMbrEmail()));
    }

}
{% endhighlight %}

# 4. UserDetails
{% highlight java linenos %}
public class Member implements UserDetails {

    private String pkId; //DB PKê°’

    private String loginId;		// ë¡œê·¸ì¸ìš© ID ê°’, emrhssla
    private String password;	// ë¹„ë°€ë²ˆí˜¸
    private String email;	//ì´ë©”ì¼
    private Integer failAuth; //ì‹¤íŒ¨íšŸìˆ˜
    private boolean emailVerified = true;	//ì´ë©”ì¼ ì¸ì¦ ì—¬ë¶€
    private String token; //SSO ì¸ì¦ í† í°

    private String nickname;
    private String sexFg;
    private String birthDy;	// ë¹„ë°€ë²ˆí˜¸
    private boolean locked = true;	//ê³„ì • ì ê¹€ ì—¬ë¶€
    private String nickname;	//ë‹‰ë„¤ì„

    private Collection<GrantedAuthority> authorities;	//ê¶Œí•œ ëª©ë¡


    /**
     * í•´ë‹¹ ìœ ì €ì˜ ê¶Œí•œ ëª©ë¡
     */
    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return authorities;
    }

    public void setRole(Collection<? extends GrantedAuthority> authorities){
        this.authorities = Collections.unmodifiableSet(sortAuthorities(authorities));
    }

    /**
     * ë¹„ë°€ë²ˆí˜¸
     */
    @Override
    public String getPassword() {
        return password;
    }


    /**
     * PKê°’
     */
    @Override
    public String getUsername() {
        return nickname;
    }

    public String getSsn() {
        return birthDy.substring(2) + sexFg;
    }

    public String getRemainFailCnt(){return String.valueOf(5-(failAuth+1));}
    public Integer getFailCnt(){return this.failAuth;}
    private void setEmailY(){
        this.emailVerified = true;
    }

    /**
     * ê³„ì • ë§Œë£Œ ì—¬ë¶€
     * true : ë§Œë£Œ ì•ˆë¨
     * false : ë§Œë£Œ
     * @return
     */
    @Override
    public boolean isAccountNonExpired() {
        return true;
    }

    /**
     * ê³„ì • ì ê¹€ ì—¬ë¶€
     * true : ì ê¸°ì§€ ì•ŠìŒ
     * false : ì ê¹€
     * @return
     */
    @Override
    public boolean isAccountNonLocked() {
        return locked;
    }

    /**
     * ë¹„ë°€ë²ˆí˜¸ ë§Œë£Œ ì—¬ë¶€
     * true : ë§Œë£Œ ì•ˆë¨
     * false : ë§Œë£Œ
     * @return
     */
    @Override
    public boolean isCredentialsNonExpired() {
        return true;
    }


    /**
     * ì‚¬ìš©ì í™œì„±í™” ì—¬ë¶€
     * ture : í™œì„±í™”
     * false : ë¹„í™œì„±í™”
     * @return
     */
    @Override
    public boolean isEnabled() {
        //ì´ë©”ì¼ì´ ì¸ì¦ë˜ì–´ ìˆê³  ê³„ì •ì´ ì ê²¨ìˆì§€ ì•Šìœ¼ë©´ true
        return true;
    }

    public Member(LoginUserDto loginUserDto) {
        //Assert.isTrue(loginUserDto.getLoginId() != null && !"".equals(loginUserDto.getLoginId()) && password != null, "Cannot pass null or empty values to constructor");
        this.loginId = loginUserDto.getLoginId();
        this.nickname = loginUserDto.getUsername();
        this.password = loginUserDto.getPwdNo();
        this.birthDy = loginUserDto.getBirthDy();
        this.sexFg = loginUserDto.getSexFg();
        this.failAuth = loginUserDto.getFailCnt();
        if(isAccountNonLocked())
            this.email = loginUserDto.getMbrEmail();
    }

    /** ì¸ì¦ëœ ì‚¬ìš©ì **/
    public static Member creatAuthorizedMember(LoginUserDto loginUserDto){
        Member member = new Member(loginUserDto);
        member.authorities = setRole("ROLE_USER");
        return member;
    }

    /** ì¸ì¦ë˜ì§€ì•Šì€ ì‚¬ìš©ì **/
    public static Member creatNoEmailMember(LoginUserDto loginUserDto){
        Member member = new Member(loginUserDto);
        member.emailVerified = false;
        member.authorities = setRole("ROLE_NOT_PERMITTED");
        return member;
    }


    /**
     * ê¶Œí•œ ì„¤ì •
     * @param role
     * @return
     */
    private static List<GrantedAuthority> setRole(String role) {
        List<GrantedAuthority> authorities = new ArrayList<GrantedAuthority>();
        authorities.add(new SimpleGrantedAuthority(role));
        return authorities;
    }

}
{% endhighlight %}


í•˜ë‚˜ì˜ ìœ ì €ëŠ” í•˜ë‚˜ì˜ ê¶Œí•œì„ ê°–ëŠ” ì •ì±…ìœ¼ë¡œ ì„¸ì› ë‹¤. ë•Œë¬¸ì— `setRole(String)`í•¨ìˆ˜ì²˜ëŸ¼ íŒŒë¼ë¯¸í„°ë¥¼ String í•˜ë‚˜ë§Œ ë°›ëŠ”ë‹¤.  
ë§Œì•½ ì‚¬ìš©ìê°€ ì—¬ëŸ¬ê°œì˜ ê¶Œí•œì„ ê°–ëŠ”ë‹¤ëŠ” ì •ì±…ì´ë©´ [RolesSpring Security - Role (ë‹¨ì¼ ê¶Œí•œ, ë³µí•© ê¶Œí•œ) ](https://chanyoung-dev.github.io/Backend/Spring/Roles/)ë¥¼ ì°¸ì¡°

# 5. AuthenticationSuccessHandler

ë¡œê·¸ì¸ ì„±ê³µì‹œ ì²˜ë¦¬ í•¸ë“¤ëŸ¬
- Handlerë§ê³  `successfulAuthentication`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì²˜ë¦¬ë„ ê°€ëŠ¥í•˜ë‹¤

<strong>successfulAuthentication</strong>ì€ í† í°ê³¼ ê°™ì´ ê°„ë‹¨í•œ ê²ƒì„ Responseì— í¬í•¨ì‹œí‚¬ ê²½ìš°ì— ì‚¬ìš©ë˜ê³ <br>
<strong>AuthenticationSuccessHandler</strong>ì€ ë¡œê·¸ì¸ì— ëŒ€í•œ ì„±ê³µ, ì‹¤íŒ¨ ë° ì‚¬ìš©ì ì •ì˜ í”„ë¡œì„¸ìŠ¤ê°€ í•„ìš”í•œ ê²½ìš°ì•  ì‚¬ìš©í•œë‹¤
{: .notice--success}

{% highlight java linenos %}
@Component
@RequiredArgsConstructor
@Slf4j
@Transactional
public class AuthSuccessHandler implements AuthenticationSuccessHandler {

    private final LoginMapper loginMapper;

    /**
     * ì¸ì¦ ì„±ê³µ ì´í›„
     * @author ê¹€ì°¬ì˜
     */
    @Override
    public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException {
        Member member = (Member) authentication.getPrincipal();
        log.info("ì‹¤íŒ¨ íšŸìˆ˜ : {}", member.getFailCnt());

        // ë¡œê·¸ì¸ ì‹¤íŒ¨íšŸìˆ˜ ì´ˆê¸°í™”
        if(member.getFailCnt()!=0)
            loginMapper.updateRestoreFailCnt(member.getMbrId());
    }
}
{% endhighlight %}

# 6. AuthenticationFailureHandler

- `AuthenticationProvider`ì—ì„œ Exceptionì´ í„°ì§€ê³  ì´í›„ì˜ Handler

{% highlight java linenos %}
@Component
@RequiredArgsConstructor
public class AuthFailureHandler implements AuthenticationFailureHandler {

    private final LoginMapper loginMapper;

    /**
     * ì¸ì¦ ì‹¤íŒ¨ ê²½ìš°
     * @author ê¹€ì°¬ì˜
     */
    @Override
    public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response,
                                        AuthenticationException exception) throws IOException, ServletException {

        // í•œê¸€ ì‚¬ìš©
        request.setCharacterEncoding("UTF-8");
        response.setCharacterEncoding("UTF-8");

        String errorMsg = "";

        if(exception instanceof AccountExpiredException){
            response.setStatus(HttpServletResponse.SC_CONFLICT);
            errorMsg = "ë§Œë£Œëœ íšŒì›ì…ë‹ˆë‹¤";
        }
        /********** 5íšŒì´ìƒ ë¹„ë°€ë²ˆí˜¸ í‹€ë ¸ì„ì‹œ ************/
        else if(exception instanceof LockedException){
            response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
            errorMsg = "ê³„ì •ì •ì§€ì…ë‹ˆë‹¤. <br> ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”";
        }
        else if(exception instanceof DisabledException){
            response.setStatus(HttpServletResponse.SC_CONFLICT);
            errorMsg = "íƒˆí‡´í•œ íšŒì›ì…ë‹ˆë‹¤";
        }
        else if(exception instanceof NoMemberException){
            response.setStatus(HttpServletResponse.SC_NOT_FOUND);
            errorMsg = "ì•„ì´ë””ë‚˜ íŒ¨ìŠ¤ì›Œë“œê°€ ì˜¬ë°”ë¥´ì§€ì•ŠìŠµë‹ˆë‹¤.";
        }

        /********** ë¹„ë°€ë²ˆí˜¸ í‹€ë ¸ì„ì‹œ ************/
        else if(exception instanceof BadCredentialsException){
            response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
            errorMsg = exception.getMessage();
        }
        else if(exception instanceof PatternException){
            response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
            errorMsg = "ì•„ì´ë””ë‚˜ íŒ¨ìŠ¤ì›Œë“œê°€ ì˜¬ë°”ë¥´ì§€ì•ŠìŠµë‹ˆë‹¤.";
        }
        response.getWriter().print(errorMsg);
        response.getWriter().flush();S

    }
}
{% endhighlight %}
- responseì— <abbr title="" id="ì‹¤íŒ¨ ì´ìœ ">errorMsg</abbr> ë¥¼ ë‹´ì•„ ajaxë¥¼ í†µí•´ í†µì‹ ìš”ì²­í•œ ë¸Œë¼ìš°ì €ì—ê²Œ ì‘ë‹µí•œë‹¤
- ì´ëŸ¬í•œ <abbr title="" id="ì‹¤íŒ¨ ì´ìœ ">errorMsg</abbr> ëŠ” `login.js`ì—ì„œ ì²˜ë¦¬í•˜ì—¬ `login.html`ì— ë³´ì—¬ì¤€ë‹¤
