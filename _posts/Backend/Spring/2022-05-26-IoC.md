---
permalink: /Backend/Spring/IoC/
title: "IoCì™€ DIì»¨í…Œì´ë„ˆ"
toc: true
categories:
  - BackendğŸ›Spring
comments: true
sidebar:
  - title: "BackendğŸ›"
  - nav: "Backend-menu"
tags:
  - Spring
  - Java
sexy: 1
main: "Spring"
header:
  teaser: https://user-images.githubusercontent.com/46098949/173234166-27483a1e-c5ba-4a82-9132-217d98575ce9.png
  overlay_image: https://user-images.githubusercontent.com/46098949/173234166-27483a1e-c5ba-4a82-9132-217d98575ce9.png
  overlay_filter: 0.5
excerpt: DI Containerì™€ `@Configuration` ê·¸ë¦¬ê³  `@Bean`ì— ëŒ€í•´ ì•Œì•„ë³´ì
---

<span style = "font-size:1.5em;  font-weight: 700;">ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆë¥¼ í†µí•œ ìƒì„±ì ì£¼ì…</span><br>
<abbr title="" id="DI ì»¨í…Œì´ë„ˆë¼ê³ ë„ í•œë‹¤">ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆ=@Configuration</abbr>ì„ í†µí•˜ì—¬ ìŠ¤í”„ë§ì˜ ë¹ˆë“¤ì˜ ê´€ê³„ë¥¼ ì£¼ì…í•´ë³´ì
{: .notice--primary}

# ìŠ¤í”„ë§ì„ ì ìš©ì•ˆí•œ DI Container

> ì¦‰ `@Configuration`ê³¼ `@Bean`ì„ ì ìš©ì•ˆí–ˆì„ë•Œ

```java
public class AppConfig {

    public MemberService memberService() {
        return new MemberService(memberRepository());
    }

    public MemberRepository memberRepository() {
        return new MemoryMemberRepository();
    }
}
```

# ìŠ¤í”„ë§ì„ ì ìš©í•œ Spring Container

```java
@Configuration
public class SpringConfig {
    @Bean
    public MemberService memberService() {
        return new MemberService(memberRepository());
    }
    @Bean
    public MemberRepository memberRepository() {
        return new MemoryMemberRepository();
    }
}
```

ë‘ê°œ ë‹¤ ì˜ì¡´ê´€ê³„ ì£¼ì…í•œë‹¤(Dependency Injection)

ê·¸ë ‡ë‹¤ë©´ ì°¨ì´ì ì€?

- ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆëŠ” **ì‹±ê¸€í†¤**ì„ ë³´ì¥í•œë‹¤

# ì‹±ê¸€í†¤

## ìŠ¤í”„ë§ì„ ì ìš©ì•ˆí•œ DI ì»¨í…Œì´ë„ˆë¥¼ í…ŒìŠ¤íŠ¸

{% highlight java linenos %}
public class SingletonTest {
	@Test
	@DisplayName("ìŠ¤í”„ë§ ì—†ëŠ” ìˆœìˆ˜í•œ DI ì»¨í…Œì´ë„ˆ")
	void pureContainer() {

	  AppConfig appConfig = new AppConfig();
    
    //1. ì¡°íšŒ: í˜¸ì¶œí•  ë•Œ ë§ˆë‹¤ ê°ì²´ë¥¼ ìƒì„±
		MemberService memberService1 = appConfig.memberService();
		//2. ì¡°íšŒ: í˜¸ì¶œí•  ë•Œ ë§ˆë‹¤ ê°ì²´ë¥¼ ìƒì„±
		MemberService memberService2 = appConfig.memberService();

		//ì°¸ì¡°ê°’ì´ ë‹¤ë¥¸ ê²ƒì„ í™•ì¸
		System.out.println("memberService1 = " + memberService1);
		System.out.println("memberService2 = " + memberService2);
    
		//memberService1 != memberService2
    assertThat(memberService1).isNotSameAs(memberService2);
  }
}
{% endhighlight %}


![image](https://user-images.githubusercontent.com/46098949/173234166-27483a1e-c5ba-4a82-9132-217d98575ce9.png)

- ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤ì´ë‹¤
- ì¦‰ ìš”ì²­ì„ í•  ë•Œë§ˆë‹¤ ê°ì²´ë¥¼ ìƒˆë¡œ ìƒì„±
- ë§Œì•½ ê³ ê° íŠ¸ë˜í”½ì´ ëª°ë¦´ë©´ ì—¬ëŸ¬ ê°ì²´ê°€ ìƒì„±ë˜ì–´ ë©”ëª¨ë¦¬ ë‚­ë¹„ê°€ ì‹¬í•˜ë‹¤
- ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ **ì‹±ê¸€í†¤ íŒ¨í„´** ë“±ì¥

## ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆë¥¼ ì‚¬ìš©í•˜ëŠ” í…ŒìŠ¤íŠ¸ ì½”ë“œ

```java
@Test
@DisplayName("ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì™€ ì‹±ê¸€í†¤")
void springContainer() {

  ApplicationContext ac = new AnnotationConfigApplicationContext(AppConfig.class);

	//1. ì¡°íšŒ: í˜¸ì¶œí•  ë•Œ ë§ˆë‹¤ ê°™ì€ ê°ì²´ë¥¼ ë°˜í™˜
  MemberService memberService1 = ac.getBean("memberService", MemberService.class);
	//2. ì¡°íšŒ: í˜¸ì¶œí•  ë•Œ ë§ˆë‹¤ ê°™ì€ ê°ì²´ë¥¼ ë°˜í™˜
  MemberService memberService2 = ac.getBean("memberService", MemberService.class);

	//ì°¸ì¡°ê°’ì´ ê°™ì€ ê²ƒì„ í™•ì¸
	System.out.println("memberService1 = " + memberService1); 
	System.out.println("memberService2 = " + memberService2);
	
	//memberService1 == memberService2
  assertThat(memberService1).isSameAs(memberService2);
}
```

<figure align="center">
<img width="805" alt="image" src='https://user-images.githubusercontent.com/46098949/173234114-fbc881d6-657a-4965-9d4e-8b1010349849.png'>
<figcaption align="center">ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆ ë•ë¶„ì— í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì´ ì˜¬ë•Œë§ˆë‹¤ ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ì´ë¯¸ ë§Œë“¤ì–´ì§„ ê°ì²´ë¥¼ ê³µìœ í•´ì„œ íš¨ìœ¨ì ìœ¼ë¡œ ì¬ì‚¬ìš©</figcaption>
</figure>

# ì‹±ê¸€í†¤ ì£¼ì˜ì 

ì—¬ëŸ¬ í´ë¼ì´ì–¸íŠ¸ê°€ í•˜ë‚˜ì˜ ê°™ì€ ê°ì²´ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê³µìœ í•˜ê¸° ë•Œë¬¸ì— ì‹±ê¸€í†¤ ê°ì²´ëŠ” ë¬´ìƒíƒœë¡œ ì„¤ê³„í•´ì•¼ í•œë‹¤

- íŠ¹ì • í´ë¼ì´ì–¸íŠ¸ê°€ ê°’ì„ ë³€ê²½í•  ìˆ˜ ìˆëŠ” í•„ë“œê°€ ìˆìœ¼ë©´ ì•ˆëœë‹¤

## ë¬¸ì œì  ì˜ˆì‹œ

---

### ë¬¸ì œê°€ ìˆëŠ” Bean(Stateful)

```java
public class StatefulService {

	private int price; //ìƒíƒœë¥¼ ìœ ì§€í•˜ëŠ” í•„ë“œ

	public void order(String name, int price) { 
		System.out.println("name = " + name + " price = " + price); 
		this.price = price; //ì—¬ê¸°ê°€ ë¬¸ì œ!
	}

  public int getPrice() {
    return price;
	} 

}
```

í…ŒìŠ¤íŠ¸ ì½”ë“œ

```java
public class StatefulServiceTest {

	@Test
	void statefulServiceSingleton() {

          ApplicationContext ac = new AnnotationConfigApplicationContext(TestConfig.class);
          StatefulService statefulService1 = ac.getBean("statefulService", StatefulService.class);
          StatefulService statefulService2 = ac.getBean("statefulService", StatefulService.class);

          //ThreadA: Aì‚¬ìš©ì 10000ì› ì£¼ë¬¸ 
          statefulService1.order("userA", 10000);
          //ThreadB: Bì‚¬ìš©ì 20000ì› ì£¼ë¬¸ 
          statefulService2.order("userB", 20000);
          //ThreadA: ì‚¬ìš©ìA ì£¼ë¬¸ ê¸ˆì•¡ ì¡°íšŒ
          int price = statefulService1.getPrice();

          //ThreadA: ì‚¬ìš©ìAëŠ” 10000ì›ì„ ê¸°ëŒ€í–ˆì§€ë§Œ, ê¸°ëŒ€ì™€ ë‹¤ë¥´ê²Œ 20000ì› ì¶œë ¥ System.out.println("price = " + price);
          Assertions.assertThat(statefulService1.getPrice()).isEqualTo(20000);

	}

	static class TestConfig {
	    @Bean
	    public StatefulService statefulService() {
	        return new StatefulService();
	    }
	} 

}
```

- `price`ëŠ” ê³µìœ í•„ë“œì¸ë°, íŠ¹ì • í´ë¼ì´ì–¸íŠ¸ê°€ ê°’ì„ ë³€ê²½í•œë‹¤
- Statelessìœ ì§€í•˜ì

---

### Stateless í…ŒìŠ¤íŠ¸ ì½”ë“œ

```java
public class StatefulService {

	//private int price; //ìƒíƒœë¥¼ ìœ ì§€í•˜ëŠ” í•„ë“œ

	public int order(String name, int price) { 
		System.out.println("name = " + name + " price = " + price); 
		//this.price = price;
		return price
	}

  

}
```

```java
public class StatelessServiceTest {

	@Test
	void statefulServiceSingleton() {

	    ApplicationContext ac = new AnnotationConfigApplicationContext(TestConfig.class);
	    StatefulService statefulService1 = ac.getBean("statelessService", StatelessService.class);
	    StatefulService statefulService2 = ac.getBean("statelessService", StatelessService.class);
	
			//ThreadA: Aì‚¬ìš©ì 10000ì› ì£¼ë¬¸ 
			int userAPrice = statelessService1.order("userA", 10000);
			//ThreadB: Bì‚¬ìš©ì 20000ì› ì£¼ë¬¸ 
			int userBPrice = statelessService2.order("userB", 20000);
			
      //ThreadA: ì‚¬ìš©ìA ì£¼ë¬¸ ê¸ˆì•¡ ì¡°íšŒ
			assertThat(userAPrice).isEqualTo(10000);

	}

	static class TestConfig {
	    @Bean
	    public StatelessService statelessService() {
	        return new StatelessService();
	    }
	} 

}
```

---

# `@Configuration`

## `@Configuration`ì´ ìˆëŠ” ê²½ìš°

```java
@Configuration
public class AppConfig {

      @Bean
      public MemberService memberService() {
          System.out.println("call AppConfig.memberService");
          return new MemberServiceImpl(memberRepository());
      }



      @Bean
      public MemberRepository memberRepository() {
          System.out.println("call AppConfig.memberRepository");
          return new MemoryMemberRepository();
      }

      @Bean
      public OrderService orderService() {
          System.out.println("call AppConfig.orderService")
          return new OrderServiceImpl(
                  memberRepository(),
                  discountPolicy());
      }

      @Bean
      public DiscountPolicy discountPolicy() {
          return new RateDiscountPolicy();
      }

}
```

ë‹¤ìŒ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰ëœë‹¤ ê°€ì • : `memberService()` â†’ `memberRepository()` 

1. `memberService()` 
    1. `System.out.println("call AppConfig.memberService");` í˜¸ì¶œ
    2. `return new MemberServiceImpl(memberRepository());` ì—ì„œ `memberRepository()` í˜¸ì¶œ
    3. `memberRepository()`ë¡œ ì´ë™ í›„, `System.out.println("call AppConfig.memberRepository");` í˜¸ì¶œ 
    4. `memberRepository()`ë¥¼ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡(ì´ë•Œ  ë¹ˆì´ë¦„ : `memberRepository()` -> ë¹ˆ ê°ì²´: `MemoryMemberRepository@CGLIB`ë¡œ ë“±ë¡)
    5. `memberService()` ë¥¼ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— ì˜ì¡´ê´€ê³„ ì£¼ì…ëœ ìƒíƒœë¡œ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡(ì´ë•Œ  ë¹ˆì´ë¦„ : `memberService()` -> ë¹ˆ ê°ì²´: `MemberServiceImpl@CGLIB`ë¡œ ë“±ë¡
2. `memberRepository()` â†’ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆì–´ì„œ ê±´ë„ˆë›´ë‹¤

â†’ `System.out.println("call AppConfig.memberRepository");` í•œë²ˆë§Œ í˜¸ì¶œëœë‹¤(ì‹±ê¸€í†¤ì„ ë³´ì¥í•´ì¤Œ)

## `@Configuration`ì´ ì—†ëŠ” ê²½ìš°

```java
//@Configuration
public class AppConfig {

    @Bean
    public MemberService memberService() {
        System.out.println("call AppConfig.memberService");
        return new MemberServiceImpl(memberRepository());

    }



    @Bean
    public MemberRepository memberRepository() {
        System.out.println("call AppConfig.memberRepository");
        return new MemoryMemberRepository();
    }

    @Bean
    public OrderService orderService() {
        System.out.println("call AppConfig.orderService")
        return new OrderServiceImpl(
                memberRepository(),
                discountPolicy()
              );

    }

    @Bean
    public DiscountPolicy discountPolicy() {
        return new RateDiscountPolicy();
    }

}
```

ìœ„ì™€ ë˜‘ê°™ì´ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰ëœë‹¤ ê°€ì • : `memberService()` â†’ `memberRepository()`  â†’ `OrderService()`

1. `memberService()` 
    1. `System.out.println("call AppConfig.memberService");` í˜¸ì¶œ
    2. `return new MemberServiceImpl(memberRepository());` ì—ì„œ `memberRepository()` í˜¸ì¶œ
    3. `memberRepository()`ë¡œ ì´ë™ í›„, `System.out.println("call AppConfig.memberRepository");` í˜¸ì¶œ 
    4. `memberRepository()`ë¥¼ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡ë˜ì§€ì•Šê³  `new MemoryMemberRepository()`ê°€ ì‹¤í–‰ë˜ì–´ ì£¼ì…ê´€ê³„ë¥¼ ë„£ëŠ”ë‹¤
        
        ì¦‰, ë‹¨ìˆœíˆ DIë§Œ í•œë‹¤
        
        ì•„ë˜ì½”ë“œì™€ ê°™ë‹¤
        
        ```java
        @Bean
        public MemberService memberService() {
            System.out.println("call AppConfig.memberService");
            return new MemberServiceImpl(new MemoryMemberRepository());
        }
        ```
        
    5. `memberService()`ë¥¼ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— ì˜ì¡´ê´€ê³„ê°€ ì£¼ì…ëœ ìƒíƒœë¡œ ìŠ¤í”„ë§ ë¹ˆ ë“±ë¡í•˜ë©´ì„œ ê°ì²´ ìƒì„±(ì´ë•Œ  ë¹ˆì´ë¦„ : `memberService()` -> ë¹ˆ ê°ì²´: `MemberServiceImpl`ë¡œ ë“±ë¡, ì˜ì¡´ê´€ê³„ ì£¼ì…
2. `memberRepository()` 
    1. `System.out.println("call AppConfig.memberRepository");` í˜¸ì¶œ
    2. `memberRepository()`ë¥¼ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡(ì´ë•Œ  ë¹ˆì´ë¦„ : `memberRepository()` -> ë¹ˆ ê°ì²´: `MemoryMemberRepository`ë¡œ ë“±ë¡)
3. `OrderService()`
    1. `System.out.println("call AppConfig.orderService")` í˜¸ì¶œ
    2. `return new OrderServiceImpl(memberRepository(), discountPolicy());`ì—ì„œ `memberRepository()` í˜¸ì¶œ
    3. `memberRepository()`ë¡œ ì´ë™ í›„, `System.out.println("call AppConfig.memberRepository");` í˜¸ì¶œ 
    4. ë‹¤ì‹œ í•œë²ˆ `new MemoryMemberRepository()` ì‹¤í–‰ 
    5. 

â†’ `System.out.println("call AppConfig.memberRepository");` 3ë²ˆ í˜¸ì¶œëœë‹¤(ì‹±ê¸€í†¤ì„ ë³´ì¥X)

### í•´ê²°ë°©ë²•

```java
public class AppConfig {

    @Autowired MemberRepository memberRepository;

    @Bean
    public MemberService memberService() {
        System.out.println("call AppConfig.memberService");
        //return new MemberServiceImpl(memberRepository());
        return new MemberServiceImpl(memberRepository);
    }



    @Bean
    public MemberRepository memberRepository() {
        System.out.println("call AppConfig.memberRepository");
        return new MemoryMemberRepository();
    }

    @Bean
    public OrderService orderService() {
        System.out.println("call AppConfig.orderService")
        return new OrderServiceImpl(
                memberRepository,
                discountPolicy()
              );
    }

    @Bean
    public DiscountPolicy discountPolicy() {
        return new RateDiscountPolicy();
    }

}
```

```java
@Bean
    public MemberRepository memberRepository() {
				System.out.println("call AppConfig.memberRepository");
        return new MemoryMemberRepository();
    }
```

- ìœ„ ì½”ë“œë¥¼ í†µí•˜ì—¬ Beanìœ¼ë¡œ ë“±ë¡ë˜ê³ 
- `@Autowired MemberRepository memberRepository;` ë¥¼ í†µí•˜ì—¬ ë‹¤ë¥¸ í•¨ìˆ˜(`memberService()`, `orderService()`)ì—ì„œë„ ë“±ë¡ëœ Beanì„ ì‚¬ìš©í•˜ê²Œ ë§Œë“ ë‹¤
- ì¦‰ ì „ë¶€ ê°™ì€ í•˜ë‚˜ì˜ Instanceì´ë‹¤

ê± `@Configuration`ì„ ë¶™ì´ì