---
permalink: /Backend/Spring/jpa/
title: "JPA"
toc: true
categories:
  - BackendğŸ›Spring
comments: true
sidebar:
  - title: "BackendğŸ›"
  - nav: "Backend-menu"
tags:
  - Spring
  - Java
sexy: 1
main: "Spring"
header:
  teaser: https://images.velog.io/images/park9910/post/dc139b53-7a2c-4973-ba88-23fb96b06b2e/image.png
  overlay_image: https://images.velog.io/images/park9910/post/dc139b53-7a2c-4973-ba88-23fb96b06b2e/image.png
  overlay_filter: 0.5
excerpt: \#ê¹€ì˜í•œ \#jpa
---


<span style = "font-size:1.5em;  font-weight: 700;">JPA</span><br>
[ì‹¤ì „! ìŠ¤í”„ë§ ë¶€íŠ¸ì™€ JPA í™œìš©2 - API ê°œë°œê³¼ ì„±ëŠ¥ ìµœì í™”](https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81%EB%B6%80%ED%8A%B8-JPA-API%EA%B0%9C%EB%B0%9C-%EC%84%B1%EB%8A%A5%EC%B5%9C%EC%A0%81%ED%99%94) ê°•ì˜ ì •ë¦¬ë³¸<br>
**JPAì™€ ì»¬ë ‰ì…˜ì— ëŒ€í•œ ì´í•´**ë¥¼ ì‚¬ìš©í•´ë³´ì<br>
{: .notice--info}




# 1.Entityë¡œ ì¡°íˆ

## 1.1 Lazyë¡œë”© ì´ìš©

Repository



```java
/**
 * JPQL ë™ì ìœ¼ë¡œ ë¬¸ìì—´ êµ¬ì„±
 * @param orderSearch
 * @return List<Order>
 */
public List<Order> findAllByString(OrderSearch orderSearch) {
    // language=JPQL
    String jpql = "select o From Order o join o.member m";
    boolean isFirstCondition = true;
    // ì£¼ë¬¸ ìƒíƒœ ê²€ìƒ‰
    if (orderSearch.getOrderStatus() != null) {
        if (isFirstCondition) {
            jpql += " where";
            isFirstCondition = false;
        } else {
            jpql += " and";
        }
        jpql += " o.status = :status";
    }
    // íšŒì› ì´ë¦„ ê²€ìƒ‰
    if (StringUtils.hasText(orderSearch.getMemberName())) {
        if (isFirstCondition) {
            jpql += " where";
            isFirstCondition = false;
        } else {
            jpql += " and";
        }
        jpql += " m.name like :name";
    }
    TypedQuery<Order> query = em.createQuery(jpql, Order.class).setMaxResults(1000); // ìµœëŒ€ 1000ê±´
    if (orderSearch.getOrderStatus() != null) {
        query = query.setParameter("status", orderSearch.getOrderStatus());
    }
    if (StringUtils.hasText(orderSearch.getMemberName())) {
        query = query.setParameter("name", orderSearch.getMemberName());
    }
    return query.getResultList();
}
```
<br/>


Controller
```java
@GetMapping("/api/v2/orders")
public List<OrderDto> ordersV2() {
    List<Order> orders = orderRepository.findAllByString(new OrderSearch());
    // ì§€ì—°ë¡œë”©ì´ê¸°ë•Œë¬¸ì— order.getMember => null, order.getOeOrdPrd => null

    List<OrderDto> result = orders.stream()
            .map(o -> new OrderDto(o))
            .collect(toList());
    return result;
}
```
<br/>

DTO
```java
@Data
static class OrderDto {
    private Long orderId;
    private String name;
    private LocalDateTime orderDate; //ì£¼ë¬¸ì‹œê°„
    private OrderStatus orderStatus;
    private Address address;
    private List<OrderItemDto> orderItems;
    public OrderDto(Order order) {
        orderId = order.getId();
        name = order.getMember().getName(); // lazy ê°•ì œ ì´ˆê¸°í™”
        orderDate = order.getOrderDate();
        orderStatus = order.getStatus();
        address = order.getDelivery().getAddress(); // lazy ê°•ì œ ì´ˆê¸°í™”
        orderItems = order.getOrderItems().stream()
                .map(orderItem -> new OrderItemDto(orderItem))
                .collect(toList());
    }
}
@Data
static class OrderItemDto {
    private String itemName;//ìƒí’ˆ ëª…
    private int orderPrice; //ì£¼ë¬¸ ê°€ê²©
    private int count; //ì£¼ë¬¸ ìˆ˜ëŸ‰
    public OrderItemDto(OrderItem orderItem) {
        itemName = orderItem.getItem().getName(); // lazy ê°•ì œ ì´ˆê¸°í™”
        orderPrice = orderItem.getOrderPrice();
        count = orderItem.getCount();
    }
}
```
<br/>

- daoì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„°
  - Order1 : `ordNo: 1, ordDt: 20250224`
  - Order2 : `ordNo: 2, ordDt: 20250225`
- ì§€ì—° ë¡œë”©ìœ¼ë¡œ ë„ˆë¬´ ë§ì€ SQL ì‹¤í–‰
- SQL ì‹¤í–‰ ìˆ˜
  - order 1ë²ˆ
  - member , address Në²ˆ(order ì¡°íšŒ ìˆ˜ ë§Œí¼)
  - orderItem Në²ˆ(order ì¡°íšŒ ìˆ˜ ë§Œí¼)
  - item Në²ˆ(orderItem ì¡°íšŒ ìˆ˜ ë§Œí¼)
  - ì—¬ê¸°ì„œ ì¡°íšŒìˆ˜ ì˜ë¯¸ì™€ **1+N**
    - ì‹¤ì œ ì‹œí€¸ìŠ¤ ì¡°íšŒìˆ˜
    - ë§Œì•½ `member`í…Œì´ë¸”ê³¼ `team`í…Œì´ë¸”ì´ ìˆë‹¤ ê°€ì •..

<span style = "font-size:1.5em;  font-weight: 700;">DB</span><br>
|ã…¤mbrIdã…¤ã…¤|ã…¤ã…¤teamIdã…¤|<br>
|ã…¤ã…¤ã…¤1ã…¤ã…¤|ã…¤ã…¤ã…¤Aã…¤ã…¤ã…¤|<br>
|ã…¤ã…¤ã…¤2ã…¤ã…¤|ã…¤ã…¤ã…¤Aã…¤ã…¤ã…¤|<br>
|ã…¤ã…¤ã…¤3ã…¤ã…¤|ã…¤ã…¤ã…¤Bã…¤ã…¤ã…¤|
{: .notice--primary}


  - `select m member m join team t` ë¥¼ ì‹¤í–‰í–ˆì„ ë•Œ.. 1ë²ˆ ì¿¼ë¦¬ì‹¤í–‰ë¨
    ```
    members.stream().forEach(member -> {
        System.out.println(member.getTeamNm());
    });
    ```
    - ìœ„ ë£¨í”„ë¥¼ ëŒë•Œë§ˆë‹¤ ì¼ì–´ë‚˜ëŠ” ì¼
    - member 1 ì¡°íšŒë ë•Œ => `select t from team t where teamId = A` ì‹¤í–‰
    - member 2 ì¡°íšŒí• ë•Œ => ì´ë¯¸ ìœ„ì—ì„œ ì¡°íšŒí–ˆìœ¼ë¯€ë¡œ ì˜ì†ì„±Contextì—ì„œ ì¡°íšŒ
    - member 3 ì¡°íšŒí• ë•Œ => `select t from team t where teamId = B` ì‹¤í–‰
    - ìµœëŒ€ 1(`member`ì¡°íšŒ) + N(`team` ì¡°íšŒ)ì´ ì‹¤í–‰ë¨
  

- ì§€ì—°ë¡œë”©ë•Œë¬¸ì— ë„ˆë¬´ ë§ì€ ì¿¼ë¦¬ê°€ ì‹¤í–‰ë˜ëŠ” ë¬¸ì œê°€ ë°œìƒ



## 1.2 fetch join ì ìš©

Repository
```java
public List<Order> findAllWithItem() {
    return em.createQuery(
                    "select distinct o from Order o" +
                            " join fetch o.member m" +
                            " join fetch o.delivery d" +
                            " join fetch o.orderItems oi" +
                            " join fetch oi.item i", Order.class)
            .getResultList();
}
```

- `distnct`ë¥¼ ì•ˆì“´ë‹¤ë©´?
  - ì•„ë˜ì²˜ëŸ¼ ë‚˜ì˜¨ë‹¤


<span style = "font-size:1.5em;  font-weight: 700;">DBì¡°íšŒê²°ê³¼</span><br>
-------------------------------------------------------------------------â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”<br>
|ã…¤ordNoã…¤|ã…¤ã…¤ordDtã…¤ã…¤ã…¤|memberNmã…¤|ã…¤prdSeqã…¤|ã…¤ã…¤prdIdã…¤ã…¤ã…¤ã…¤|ã…¤ã…¤prdNmã…¤ã…¤|<br>
|ã…¤ã…¤ã…¤1ã…¤ã…¤|ã…¤20250224ã…¤|ã…¤ã…¤ê¹€ì°¬ì˜ã…¤ã…¤|ã…¤ã…¤ã…¤1ã…¤ã…¤ã…¤|ã…¤ã…¤ã…¤1542ã…¤ã…¤ã…¤|ã…¤ã…¤ã…¤ì—°í•„ã…¤ã…¤|<br>
|ã…¤ã…¤ã…¤1ã…¤ã…¤|ã…¤20250224ã…¤|ã…¤ã…¤ê¹€ì°¬ì˜ã…¤ã…¤|ã…¤ã…¤ã…¤2ã…¤ã…¤ã…¤|ã…¤ã…¤ã…¤1252ã…¤ã…¤ã…¤|ã…¤ã…¤ã…¤ì§€ìš°ê°œã…¤|<br>
|ã…¤ã…¤ã…¤2ã…¤ã…¤|ã…¤20250225ã…¤|ã…¤ã…¤ê¹€ì°¬ì˜ã…¤ã…¤|ã…¤ã…¤ã…¤1ã…¤ã…¤ã…¤|ã…¤ã…¤ã…¤1542ã…¤ã…¤ã…¤|ã…¤ã…¤ã…¤ì—°í•„ã…¤ã…¤|<br>
|ã…¤ã…¤ã…¤2ã…¤ã…¤|ã…¤20250225ã…¤|ã…¤ã…¤ê¹€ì°¬ì˜ã…¤ã…¤|ã…¤ã…¤ã…¤2ã…¤ã…¤ã…¤|ã…¤ã…¤ã…¤849 ã…¤ã…¤ã…¤|ã…¤ã…¤ã…¤ë¶„í•„ã…¤ã…¤|<br>
------------------------------------------------------------------------â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
{: .notice--primary}


  - why? fetch joinì„ í•˜ê¸°ë•Œë¬¸ì— ì¦‰ê°ì ìœ¼ë¡œ í•œë²ˆì— í•„ìš”í•œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê¸°ë•Œë¬¸ì— ë»¥íŠ€ê¸°ê°€ ëœë‹¤


- `distinct`ë¥¼ ì“´ë‹¤ë©´?
  - ì¼ë‹¨ DBë‹¨ì—ì„œ ê´€ë ¨ëœ ê°’ë“¤ì„ ì „ë¶€ ì¡°íšŒí•´ì˜´(ë¬¼ë¡  ì´ë•Œë„ DBì— `distinct`ë¥¼ ì‚¬ìš©í•¨)
  - `Order` ê°ì²´ì™€ ê´€ë ¨ëœ ì—”í‹°í‹°(`OeOrdPrd`, `Member`)ë“¤ì„ í•œêº¼ë²ˆì— ê°ì²´ ì£¼ì…
  - `Order` ê°ì²´ ì£¼ì†Œê°’ì„ ê¸°ì¤€ìœ¼ë¡œ ì¤‘ë³µì´ ìˆìœ¼ë©´ ì œê±°ë¨
  - ì™„ë²½í•œê²ƒê°™ì§€ë§Œ.. í˜ì´ì§•(ex 1ë²ˆë¶€í„° 100ë²ˆê¹Œì§€ ê°€ì ¸ì™€)ê°™ì€ ì²˜ë¦¬ê°€ ë¶ˆê°€ëŠ¥ => ì•±ë‹¨ì—ì„œ í˜ì´ì§•ì„ í•˜ê¸°ë•Œë¬¸!


1:N:Nê³¼ ê°™ì€ ê²½ìš°ëŠ” ì•ˆëœë‹¤!
{: .notice--warning}


## 1.3 í˜ì¹˜ì¡°ì¸ ë³´ì•ˆ

Repository
```java
public List<Order> findAllWithMemberDelivery(int offset, int limit) {
    return em.createQuery(
                    "select o from Order o" +
                            " join fetch o.member m" +
                            " join fetch o.delivery d", Order.class)
            .setFirstResult(offset)
            .setMaxResults(limit)
            .getResultList();
}
```

ToOneê´€ê³„ë§Œ fetch Joiní•˜ê³  ë‚˜ë¨¸ì§€ëŠ” `hibernate.default_batch_fetch_size`ë¥¼ í†µí•˜ì—¬ ê´€ë ¨ëœ `OeOrdPrd`ë¥¼ ì—¬ëŸ¬ê°œ ê°–ê³ ì˜¨ë‹¤
- `select ... OeOrdPrd o where ordNo in (1511, 1512, ..., 1610);`



# 2. DTOë¡œ ì¡°íšŒ(ì§ì ‘ ì¡°íšŒ)

## 2.1 1 + N (ì»¬ë ‰ì…˜)

DTO
```java
@Data
@EqualsAndHashCode(of = "orderId")
public class OrderQueryDto {
    private Long orderId;
    private String name;
    private LocalDateTime orderDate; //ì£¼ë¬¸ì‹œê°„
    private OrderStatus orderStatus;
    private Address address;
    private List<OrderItemQueryDto> orderItems;
    public OrderQueryDto(Long orderId, String name, LocalDateTime orderDate,
                          OrderStatus orderStatus, Address address) {
        this.orderId = orderId;
        this.name = name;
        this.orderDate = orderDate;
        this.orderStatus = orderStatus;
        this.address = address;
    }
}


@Data
public class OrderItemQueryDto {
    @JsonIgnore
    private Long orderId; //ì£¼ë¬¸ë²ˆí˜¸
    private String itemName;//ìƒí’ˆ ëª…
    private int orderPrice; //ì£¼ë¬¸ ê°€ê²©
    private int count; //ì£¼ë¬¸ ìˆ˜ëŸ‰
    public OrderItemQueryDto(Long orderId, String itemName, int orderPrice, int
            count) {
        this.orderId = orderId;
        this.itemName = itemName;
        this.orderPrice = orderPrice;
        this.count = count;
    }
}

```
<br/>



Repository
```java

/**
 * ì»¬ë ‰ì…˜ì€ ë³„ë„ë¡œ ì¡°íšŒ
 * Query: ë£¨íŠ¸ 1ë²ˆ, ì»¬ë ‰ì…˜ N ë²ˆ
 * ë‹¨ê±´ ì¡°íšŒì—ì„œ ë§ì´ ì‚¬ìš©í•˜ëŠ” ë°©ì‹
 */
public List<OrderQueryDto> findOrderQueryDtos() {
    //ë£¨íŠ¸ ì¡°íšŒ(toOne ì½”ë“œë¥¼ ëª¨ë‘ í•œë²ˆì— ì¡°íšŒ)
    List<OrderQueryDto> result = findOrders();
    //ë£¨í”„ë¥¼ ëŒë©´ì„œ ì»¬ë ‰ì…˜ ì¶”ê°€(ì¶”ê°€ ì¿¼ë¦¬ ì‹¤í–‰)
    result.forEach(o -> {
        List<OrderItemQueryDto> orderItems = findOrderItems(o.getOrderId());
        o.setOrderItems(orderItems);
    });
    return result;
}


/**
 * 1:N ê´€ê³„(ì»¬ë ‰ì…˜)ë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ë¥¼ í•œë²ˆì— ì¡°íšŒ
 */
private List<OrderQueryDto> findOrders() {
    return em.createQuery(
                    "select new 
                    jpabook.jpashop.repository.order.query.OrderQueryDto(o.id, m.name, o.orderDate,
                            o.status, d.address)" +
                    " from Order o" +
                            " join o.member m" +
                            " join o.delivery d", OrderQueryDto.class)
            .getResultList();
}


/**
 * 1:N ê´€ê³„ì¸ orderItems ì¡°íšŒ
 */
private List<OrderItemQueryDto> findOrderItems(Long orderId) {
    return em.createQuery(
                    "select new 
                    jpabook.jpashop.repository.order.query.OrderItemQueryDto(oi.order.id, i.name,
                            oi.orderPrice, oi.count)" +
                    " from OrderItem oi" +
                            " join oi.item i" +
                            " where oi.order.id = : orderId",
                    OrderItemQueryDto.class)
            .setParameter("orderId", orderId)
            .getResultList();
}


```


- ì¿¼ë¦¬ ì‹¤í–‰ íšŸìˆ˜: ë£¨íŠ¸ 1ë²ˆ, ì»¬ë ‰ì…˜ N ë²ˆ ì‹¤í–‰
- ToOne(N:1, 1:1) ê´€ê³„ë“¤ì„ ë¨¼ì € ì¡°íšŒí•˜ê³ (`findOrders()`), ToMany(1:N) ê´€ê³„ëŠ” ê°ê° ë³„ë„ë¡œ ì²˜ë¦¬(`findOrderItems()`)í•œë‹¤.
  - ToOne ê´€ê³„ëŠ” ì¡°ì¸í•´ë„ ë°ì´í„° row ìˆ˜ê°€ ì¦ê°€í•˜ì§€ ì•ŠëŠ”ë‹¤.
  - ToMany(1:N) ê´€ê³„ëŠ” ì¡°ì¸í•˜ë©´ row ìˆ˜ê°€ ì¦ê°€í•œë‹¤.
- row ìˆ˜ê°€ ì¦ê°€í•˜ì§€ ì•ŠëŠ” ToOne ê´€ê³„ëŠ” ì¡°ì¸ìœ¼ë¡œ ìµœì í™” í•˜ê¸° ì‰¬ìš°ë¯€ë¡œ í•œë²ˆì— ì¡°íšŒí•˜ê³ , ToMany ê´€ê³„ëŠ” ìµœì í™” í•˜ê¸° ì–´ë ¤ìš°ë¯€ë¡œ `findOrderItems()` ê°™ì€ ë³„ë„ì˜ ë©”ì„œë“œë¡œ ì¡°íšŒí•œë‹¤.


<span style = "font-size:1.5em;  font-weight: 700;">fetch joinì´ ì•„ë‹Œë°ë„ ë¶ˆêµ¬í•˜ê³  í•œë²ˆì— ë˜ëŠ” ì´ìœ ?</span><br>
ì—¬ê¸°ì„œëŠ” ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ì›í•˜ëŠ” ë°ì´í„°ë¥¼ ëª¨ë‘ ì¡°ì¸í•´ì„œ í•œë²ˆì— í•„ìš”í•œ ë°ì´í„°ë§Œ ì¡°íšŒí•˜ëŠ” ë°©ì‹ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ì¡°íšŒ ë°©ì‹ì„ DTOë¡œ ì¡°íšŒí•˜ëŠ” ë°©ì‹ì´ë¼ê³  ì¼ë°˜ì ìœ¼ë¡œ ì´ì•¼ê¸°í•©ë‹ˆë‹¤.<br/>
ì´ë ‡ê²Œ DTOë¡œ ì¡°íšŒí•˜ê²Œ ë˜ë©´ **ì—”í‹°í‹°ê°€ ì•„ë‹™ë‹ˆë‹¤**. ë”°ë¼ì„œ **ì§€ì—°ë¡œë”©, Fetch joinë“±ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤**.<br/>
ì´ë ‡ê²Œ DTOë¡œ ì¡°íšŒí•˜ë ¤ë©´ SQLì˜ JOIN ë¬¸ì„ ì‚¬ìš©í•´ì„œ ì²˜ìŒë¶€í„° ì›í•˜ëŠ” ë°ì´í„°ë¥¼ ëª¨ë‘ ì„ íƒí•´ì„œ ì¡°íšŒí•´ì•¼ í•©ë‹ˆë‹¤.<br/>
{: .notice--warning}



## 2.2 1:Nì˜ ì¿¼ë¦¬ë¥¼ INì ˆë¡œ ì¡°íšŒ

Repository
```java
/**
 * ìµœì í™”
 * Query: ë£¨íŠ¸ 1ë²ˆ, ì»¬ë ‰ì…˜ 1ë²ˆ
 * ë°ì´í„°ë¥¼ í•œêº¼ë²ˆì— ì²˜ë¦¬í•  ë•Œ ë§ì´ ì‚¬ìš©í•˜ëŠ” ë°©ì‹
 *
 */
public List<OrderQueryDto> findAllByDto_optimization() {
    //ë£¨íŠ¸ ì¡°íšŒ(toOne ì½”ë“œë¥¼ ëª¨ë‘ í•œë²ˆì— ì¡°íšŒ)
    List<OrderQueryDto> result = findOrders();
    //orderItem ì»¬ë ‰ì…˜ì„ MAP í•œë°©ì— ì¡°íšŒ
    Map<Long, List<OrderItemQueryDto>> orderItemMap =
            findOrderItemMap(toOrderIds(result));
    //ë£¨í”„ë¥¼ ëŒë©´ì„œ ì»¬ë ‰ì…˜ ì¶”ê°€(ì¶”ê°€ ì¿¼ë¦¬ ì‹¤í–‰X)
    result.forEach(o -> o.setOrderItems(orderItemMap.get(o.getOrderId())));
    return result;
}
private List<Long> toOrderIds(List<OrderQueryDto> result) {
    return result.stream()
            .map(o -> o.getOrderId())
            .collect(Collectors.toList());
}
private Map<Long, List<OrderItemQueryDto>> findOrderItemMap(List<Long> orderIds)
{
    List<OrderItemQueryDto> orderItems = em.createQuery(
                    "select new 
                    jpabook.jpashop.repository.order.query.OrderItemQueryDto(oi.order.id, i.name,
                            oi.orderPrice, oi.count)" +
                    " from OrderItem oi" +
                            " join oi.item i" +
                            " where oi.order.id in :orderIds", OrderItemQueryDto.class)
            .setParameter("orderIds", orderIds)
            .getResultList();
    return orderItems.stream()
            .collect(Collectors.groupingBy(OrderItemQueryDto::getOrderId));
}
```

- ì¿¼ë¦¬ ì‹¤í–‰ íšŸìˆ˜: ë£¨íŠ¸ 1ë²ˆ, ì»¬ë ‰ì…˜ 1ë²ˆ
- ToOne ê´€ê³„ë“¤ì„ ë¨¼ì € ì¡°íšŒí•˜ê³ , ì—¬ê¸°ì„œ ì–»ì€ ì‹ë³„ì `orderId`ë¡œ ToMany ê´€ê³„ì¸ `OrderItem` ì„ í•œêº¼ë²ˆì— ì¡°íšŒ


## 2.3 í•œë°©ì¿¼ë¦¬
- ëª¨ë‘ í•œêº¼ë²ˆì— í•œë°©ì¿¼ë¦¬ë¡œ ì¡°íšŒí•˜ê³  ìë°”ë‹¨ì—ì„œ ë§ì¶°ì¤€ë‹¤.

Repository
```java
@Data
public class OrderFlatDto {
    private Long orderId;
    private String name;
    private LocalDateTime orderDate; //ì£¼ë¬¸ì‹œê°„
    private Address address;
    private OrderStatus orderStatus;
    private String itemName;//ìƒí’ˆ ëª…
    private int orderPrice; //ì£¼ë¬¸ ê°€ê²©
    private int count; //ì£¼ë¬¸ ìˆ˜ëŸ‰
    public OrderFlatDto(Long orderId, String name, LocalDateTime orderDate,
                        OrderStatus orderStatus, Address address, String itemName, int orderPrice, int
                                count) {
        this.orderId = orderId;
        this.name = name;
        this.orderDate = orderDate;
        this.orderStatus = orderStatus;
        this.address = address;
        this.itemName = itemName;
        this.orderPrice = orderPrice;
        this.count = count;
    }
}



public List<OrderFlatDto> findAllByDto_flat() {
    return em.createQuery(
                    "select new 
                    jpabook.jpashop.repository.order.query.OrderFlatDto(o.id, m.name, o.orderDate,
                            o.status, d.address, i.name, oi.orderPrice, oi.count)" +
                    " from Order o" +
                            " join o.member m" +
                            " join o.delivery d" +
                            " join o.orderItems oi" +
                            " join oi.item i", OrderFlatDto.class)
            .getResultList();
}

```
<br/>

`OrderQueryDto`ì— `List<OrderItemQueryDto>`ë¥¼ ì¶”ê°€ë¡œ ì¸ì ë°›ëŠ” ìƒì„±ì ì¶”ê°€
```java
public OrderQueryDto(Long orderId, String name, LocalDateTime orderDate,
                      OrderStatus orderStatus, Address address, List<OrderItemQueryDto> orderItems) {
    this.orderId = orderId;
    this.name = name;
    this.orderDate = orderDate;
    this.orderStatus = orderStatus;
    this.address = address;
    this.orderItems = orderItems;
}

```
<br/>

Controller
```java
@GetMapping("/api/v6/orders")
public List<OrderQueryDto> ordersV6() {
    List<OrderFlatDto> flats = orderQueryRepository.findAllByDto_flat();
    return flats.stream()
            .collect(groupingBy(o -> new OrderQueryDto(o.getOrderId(),
                            o.getName(), o.getOrderDate(), o.getOrderStatus(), o.getAddress()),
                    mapping(o -> new OrderItemQueryDto(o.getOrderId(),
                            o.getItemName(), o.getOrderPrice(), o.getCount()), toList())
            )).entrySet().stream()
            .map(e -> new OrderQueryDto(e.getKey().getOrderId(),
                    e.getKey().getName(), e.getKey().getOrderDate(), e.getKey().getOrderStatus(),
                    e.getKey().getAddress(), e.getValue()))
            .collect(toList());
}
```










